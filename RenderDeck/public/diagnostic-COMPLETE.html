<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RenderDeck Complete Diagnostic</title>
  <script type="importmap">{
    "imports": {
      "three": "https://unpkg.com/three@0.175.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.175.0/examples/jsm/"
    }
  }</script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(26, 26, 26, 0.95);
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #4CAF50;
      font-size: 2.5em;
      margin: 0 0 10px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .subtitle {
      color: #aaa;
      margin-bottom: 30px;
      font-size: 1.1em;
    }
    .section {
      margin: 30px 0;
      padding: 20px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      border-left: 4px solid #2196F3;
    }
    .section h2 {
      color: #2196F3;
      margin-top: 0;
      font-size: 1.5em;
    }
    .test {
      padding: 12px 15px;
      margin: 8px 0;
      border-radius: 6px;
      border-left: 4px solid;
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
    }
    .test:hover {
      transform: translateX(5px);
    }
    .pass {
      background: rgba(76, 175, 80, 0.2);
      border-left-color: #4CAF50;
    }
    .fail {
      background: rgba(244, 67, 54, 0.2);
      border-left-color: #f44336;
    }
    .warn {
      background: rgba(255, 152, 0, 0.2);
      border-left-color: #ff9800;
    }
    .info {
      background: rgba(33, 150, 243, 0.2);
      border-left-color: #2196F3;
    }
    .icon {
      font-size: 1.5em;
      margin-right: 15px;
      min-width: 30px;
    }
    .content {
      flex: 1;
    }
    .test strong {
      display: block;
      margin-bottom: 5px;
      font-size: 1.1em;
    }
    .test-detail {
      opacity: 0.9;
      font-size: 0.95em;
    }
    code {
      background: rgba(0,0,0,0.4);
      padding: 2px 8px;
      border-radius: 4px;
      color: #ffa726;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
    .progress {
      margin: 20px 0;
      text-align: center;
    }
    .progress-bar {
      width: 100%;
      height: 30px;
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .summary {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(33, 150, 243, 0.2));
      padding: 25px;
      border-radius: 8px;
      margin-top: 30px;
    }
    .summary h2 {
      margin-top: 0;
      color: #4CAF50;
    }
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 6px;
      text-align: center;
    }
    .stat-value {
      font-size: 2em;
      font-weight: bold;
      margin: 10px 0;
    }
    .stat-label {
      color: #aaa;
      font-size: 0.9em;
    }
    ul {
      margin: 15px 0;
      padding-left: 20px;
    }
    li {
      margin: 8px 0;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç RenderDeck Complete Diagnostic</h1>
    <p class="subtitle">Testing your setup from: <code id="current-url"></code></p>
    
    <div class="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progress" style="width: 0%">0%</div>
      </div>
      <p id="status">Initializing tests...</p>
    </div>
    
    <div id="results"></div>
    
    <div class="summary" id="summary" style="display: none;">
      <h2>üìä Test Summary</h2>
      <div class="stat-grid">
        <div class="stat">
          <div class="stat-label">Passed</div>
          <div class="stat-value" style="color: #4CAF50;" id="passed-count">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">Failed</div>
          <div class="stat-value" style="color: #f44336;" id="failed-count">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">Warnings</div>
          <div class="stat-value" style="color: #ff9800;" id="warn-count">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">Total Tests</div>
          <div class="stat-value" style="color: #2196F3;" id="total-count">0</div>
        </div>
      </div>
      <div id="final-message"></div>
    </div>
  </div>
  
  <script type="module">
    document.getElementById('current-url').textContent = window.location.href;
    
    const results = document.getElementById('results');
    let passCount = 0;
    let failCount = 0;
    let warnCount = 0;
    let totalTests = 0;
    
    function updateProgress(percent, message) {
      const progressBar = document.getElementById('progress');
      const status = document.getElementById('status');
      progressBar.style.width = percent + '%';
      progressBar.textContent = Math.round(percent) + '%';
      status.textContent = message;
    }
    
    function createSection(title) {
      const section = document.createElement('div');
      section.className = 'section';
      section.innerHTML = `<h2>${title}</h2>`;
      results.appendChild(section);
      return section;
    }
    
    function test(section, name, condition, passMsg, failMsg, isWarning = false) {
      totalTests++;
      const div = document.createElement('div');
      const type = condition ? 'pass' : (isWarning ? 'warn' : 'fail');
      div.className = `test ${type}`;
      
      let icon = '‚úÖ';
      if (!condition) {
        if (isWarning) {
          icon = '‚ö†Ô∏è';
          warnCount++;
        } else {
          icon = '‚ùå';
          failCount++;
        }
      } else {
        passCount++;
      }
      
      div.innerHTML = `
        <span class="icon">${icon}</span>
        <div class="content">
          <strong>${name}</strong>
          <div class="test-detail">${condition ? passMsg : failMsg}</div>
        </div>
      `;
      section.appendChild(div);
      return condition;
    }
    
    function info(section, message) {
      const div = document.createElement('div');
      div.className = 'test info';
      div.innerHTML = `
        <span class="icon">‚ÑπÔ∏è</span>
        <div class="content">
          <div class="test-detail">${message}</div>
        </div>
      `;
      section.appendChild(div);
    }
    
    // Start tests
    updateProgress(5, 'Testing basic setup...');
    
    // Section 1: Server & Import Map
    const basicSection = createSection('üåê Basic Setup');
    
    test(
      basicSection,
      'Using Local Server',
      window.location.protocol === 'http:' || window.location.protocol === 'https:',
      `Running on ${window.location.protocol}//`,
      `Using ${window.location.protocol} - MUST use http:// with a local server!`
    );
    
    test(
      basicSection,
      'Import Map Present',
      document.querySelector('script[type="importmap"]') !== null,
      'Import map found - Three.js can load',
      'Missing import map! Add to index.html'
    );
    
    updateProgress(15, 'Testing Three.js...');
    
    // Section 2: Three.js
    const threeSection = createSection('üì¶ Three.js Library');
    
    let threeLoaded = false;
    try {
      const THREE = await import('three');
      threeLoaded = !!THREE.Scene;
      test(
        threeSection,
        'Three.js Module',
        threeLoaded,
        `Three.js loaded successfully (r${THREE.REVISION})`,
        'Three.js failed to load'
      );
    } catch (e) {
      test(
        threeSection,
        'Three.js Module',
        false,
        '',
        `Error: ${e.message}`
      );
    }
    
    updateProgress(25, 'Checking file structure...');
    
    // Section 3: JavaScript Files
    const jsSection = createSection('üìÅ JavaScript Files');
    
    const jsTests = [
      { file: 'js/config.js', name: 'config.js', critical: true },
      { file: 'js/main.js', name: 'main.js', critical: true },
      { file: 'js/scenes.js', name: 'scenes.js', critical: true },
      { file: 'js/core/Scene.js', name: 'core/Scene.js', critical: true },
      { file: 'js/core/Renderer.js', name: 'core/Renderer.js', critical: true },
      { file: 'js/core/Camera.js', name: 'core/Camera.js', critical: true },
      { file: 'js/materials/MaterialManager.js', name: 'materials/MaterialManager.js', critical: true },
      { file: 'js/materials/generators.js', name: 'materials/generators.js', critical: true },
      { file: 'js/models/ModelManager.js', name: 'models/ModelManager.js', critical: true },
      { file: 'js/ui/UVEditor.js', name: 'ui/UVEditor.js', critical: true },
      { file: 'js/ui/Controls.js', name: 'ui/Controls.js', critical: true },
    ];
    
    let jsFound = 0;
    for (const t of jsTests) {
      try {
        const response = await fetch(t.file);
        const exists = response.ok;
        if (exists) jsFound++;
        test(
          jsSection,
          t.name,
          exists,
          `Found (${response.status})`,
          `Not found (${response.status}) - Check: ${t.file}`,
          !t.critical
        );
      } catch (e) {
        test(jsSection, t.name, false, '', `Error: ${e.message}`);
      }
    }
    
    updateProgress(50, 'Testing asset paths...');
    
    // Section 4: Model Files (one level up from public/)
    const modelSection = createSection('üé® 3D Model Files');
    
    const modelTests = [
      { path: '../models/plain_mug/mug.obj', name: 'Plain Mug (.obj)' },
      { path: '../models/simple_pen/pen.obj', name: 'Simple Pen (.obj)' },
      { path: '../models/simple_pen/pen.mtl', name: 'Simple Pen (.mtl)' },
    ];
    
    let modelsFound = 0;
    for (const t of modelTests) {
      try {
        const response = await fetch(t.path);
        const exists = response.ok;
        if (exists) modelsFound++;
        test(
          modelSection,
          t.name,
          exists,
          `Found at ${t.path}`,
          `Not found - Tried: ${t.path}`,
          t.path.includes('.mtl') // MTL files are optional
        );
      } catch (e) {
        test(modelSection, t.name, false, '', `Error: ${e.message}`);
      }
    }
    
    updateProgress(65, 'Testing HDR scenes...');
    
    // Section 5: Scene Files (one level up from public/)
    const sceneSection = createSection('üåÖ HDR Environment Files');
    
    const sceneTests = [
      { path: '../scenes/studio_kominka_02_2k.hdr', name: 'Studio Kominka' },
      { path: '../scenes/lebombo_2k.hdr', name: 'Lebombo' },
    ];
    
    let scenesFound = 0;
    for (const t of sceneTests) {
      try {
        const response = await fetch(t.path);
        const exists = response.ok;
        if (exists) scenesFound++;
        test(
          sceneSection,
          t.name,
          exists,
          `Found at ${t.path}`,
          `Not found - Download from polyhaven.com`
        );
      } catch (e) {
        test(sceneSection, t.name, false, '', `Error: ${e.message}`);
      }
    }
    
    updateProgress(80, 'Testing module imports...');
    
    // Section 6: Import Tests
    const importSection = createSection('üîó Module Imports');
    
    try {
      const config = await import('./js/config.js');
      test(
        importSection,
        'config.js',
        !!config.CONFIG,
        `Loaded - MODEL_PATHS: "${config.MODEL_PATHS?.BASE_PATH}", SCENE_PATHS: "${config.SCENE_PATHS?.BASE_PATH}"`,
        'CONFIG export not found'
      );
      
      // Check if paths are correct
      test(
        importSection,
        'MODEL_PATHS.BASE_PATH',
        config.MODEL_PATHS?.BASE_PATH === '../models/',
        'Correct: "../models/"',
        `Wrong: "${config.MODEL_PATHS?.BASE_PATH}" (should be "../models/")`
      );
      
      test(
        importSection,
        'SCENE_PATHS.BASE_PATH',
        config.SCENE_PATHS?.BASE_PATH === '../scenes/',
        'Correct: "../scenes/"',
        `Wrong: "${config.SCENE_PATHS?.BASE_PATH}" (should be "../scenes/")`
      );
      
      // Check PLAIN_MUG mtl value
      const mtlValue = config.MODEL_PATHS?.PLAIN_MUG?.mtl;
      test(
        importSection,
        'PLAIN_MUG.mtl Setting',
        mtlValue === null,
        'Correct: null (mug.mtl doesn\'t exist)',
        `Set to "${mtlValue}" but should be null (you don't have mug.mtl)`,
        true // warning
      );
      
    } catch (e) {
      test(importSection, 'config.js', false, '', `Cannot import: ${e.message}`);
    }
    
    // Test case-sensitive imports
    info(importSection, 'Testing case-sensitive file names...');
    
    const caseTests = [
      { file: './js/materials/MaterialManager.js', name: 'MaterialManager.js' },
      { file: './js/models/ModelManager.js', name: 'ModelManager.js' },
      { file: './js/ui/UVEditor.js', name: 'UVEditor.js' },
    ];
    
    for (const t of caseTests) {
      try {
        const response = await fetch(t.file);
        test(
          importSection,
          `Case: ${t.name}`,
          response.ok,
          'Correct capitalization',
          `File not found - check main.js imports match exact file names`
        );
      } catch (e) {
        test(importSection, `Case: ${t.name}`, false, '', e.message);
      }
    }
    
    updateProgress(95, 'Checking index.html...');
    
    // Section 7: index.html checks
    const htmlSection = createSection('üìÑ index.html Configuration');
    
    try {
      const response = await fetch('index.html');
      const html = await response.text();
      
      test(
        htmlSection,
        'Script Tag Path',
        html.includes('src="js/main.js"'),
        'Correct: <code>src="js/main.js"</code>',
        'Wrong path - should be <code>src="js/main.js"</code> not <code>src="main.js"</code>'
      );
      
      test(
        htmlSection,
        'Opacity Slider ID',
        html.includes('id="opacity-slider"'),
        'Found: <code>id="opacity-slider"</code>',
        'Wrong ID - should be "opacity-slider" not "transparency-slider"',
        true
      );
      
      test(
        htmlSection,
        'Roughness Slider ID',
        html.includes('id="roughness-slider"'),
        'Found: <code>id="roughness-slider"</code>',
        'Wrong ID - should be "roughness-slider" not "shadows-slider"',
        true
      );
      
      test(
        htmlSection,
        'Metalness Slider ID',
        html.includes('id="metalness-slider"'),
        'Found: <code>id="metalness-slider"</code>',
        'Wrong ID - should be "metalness-slider" not "reflexivity-slider"',
        true
      );
      
      test(
        htmlSection,
        'Scene Container',
        html.includes('scene-view-placeholder'),
        'Found: <code>.scene-view-placeholder</code>',
        'Missing scene container div'
      );
      
    } catch (e) {
      test(htmlSection, 'index.html', false, '', `Cannot read: ${e.message}`);
    }
    
    updateProgress(100, 'Complete!');
    
    // Show summary
    document.getElementById('passed-count').textContent = passCount;
    document.getElementById('failed-count').textContent = failCount;
    document.getElementById('warn-count').textContent = warnCount;
    document.getElementById('total-count').textContent = totalTests;
    
    const summaryDiv = document.getElementById('summary');
    const messageDiv = document.getElementById('final-message');
    summaryDiv.style.display = 'block';
    
    if (failCount === 0) {
      messageDiv.innerHTML = `
        <h3 style="color: #4CAF50;">üéâ All Critical Tests Passed!</h3>
        <p>Your RenderDeck setup looks good! If you still have issues:</p>
        <ul>
          <li>Hard refresh browser (Ctrl+Shift+R or Cmd+Shift+R)</li>
          <li>Check browser console (F12) for errors</li>
          <li>Make sure you're viewing index.html, not this diagnostic page</li>
        </ul>
        ${warnCount > 0 ? '<p><strong>Note:</strong> You have ' + warnCount + ' warning(s) - these are optional but recommended to fix.</p>' : ''}
      `;
    } else {
      messageDiv.innerHTML = `
        <h3 style="color: #f44336;">‚ö†Ô∏è Issues Found</h3>
        <p><strong>${failCount} critical issue(s)</strong> need to be fixed:</p>
        <ul>
          <li>Check red ‚ùå items above</li>
          <li>Download fixed files from outputs folder</li>
          <li>Make sure file names match exactly (case-sensitive)</li>
          <li>Verify all paths in config.js are correct</li>
        </ul>
        <p><strong>Common fixes:</strong></p>
        <ul>
          <li>Change <code>src="main.js"</code> to <code>src="js/main.js"</code> in index.html</li>
          <li>Fix import paths in main.js (MaterialManager, ModelManager, UVEditor)</li>
          <li>Set PLAIN_MUG.mtl to null in config.js</li>
          <li>Add models and scenes folders one level above public/</li>
        </ul>
      `;
    }
    
    updateProgress(100, `Complete! ${passCount} passed, ${failCount} failed, ${warnCount} warnings`);
  </script>
</body>
</html>